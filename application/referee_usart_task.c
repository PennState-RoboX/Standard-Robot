/**
  ****************************(C) COPYRIGHT 2019 DJI****************************
  * @file       referee_usart_task.c/h
  * @brief      RM referee system data solve. RMé—‚å‚šå€¸éŠå³°Ã¹é¥Ñ…æš¦é–»ãˆ¢Ç¹ç»æ¥ƒâ‚¬å¹¿å„±é·å?ã€’æ¿ æ°?…™é–»æˆÉ‘éˆ·æ—æŸ£é?ç‚´î—œé–µå—˜å¸’é¡«æ¿‹æ•é›î„€î—šé—è¯²æ°¦é¡??Ãºéî‚¤ç¤Šå©µçŠ²æ´¤ç» æ ­æŸ›é¾æ¥€å€¹é•å†?¢ºé‘ºãƒƒîˆË‡æµ å¬?¹æ¿å—˜æŒ»éˆ·æ‘Ã¹é”å‘?ƒˆé¢îˆåŸ–éŠ‡å‹?”•é”å—™î˜°éè§„æ´˜é”æ›¡çƒé—å‘Šä¾—é˜è—‰Î£é¡’å‹¬â’‘ç¼‚ä½¹Ç˜ç¼‚æ°±ç´’é¡•å‘­ç¦é–¹î†¹â‚¬æ–¥æ?æ¿¡îˆšç¹ç¼å©‡å¼«é°æ¿å·æ¤¤æ—‡æ?é“å«ä¿Šéî„â‚¬Ñ…ç´éˆ§î„„æŸ›ç€£î‚¢å§é–¸â”¾å“å¦ã‚†å¸’é æ°?¸¿é°ç‰ˆç…™é–¸æ¿„å„±é˜æ’®æŸŸé?æƒ§ä»±é–ºä½¸å•´é©â‚?¤¤æ‘å?éå?æŸ•æ¾¶å—˜æ«…ç¼â‚¬ç€£î‚ äºœé–ºå¶ƒåŠé¨æˆã„é””èŠ¥ç·²æ¤¤î„å•´æ¿¡å •å´±å¦?ƒ˜æ®?—‚ä½¸æ‘œæ¿?’®æŸŠé”å¤Šæ˜¥é–³ÑŒå‰šéŠ‡å‹¯å¹’é´îˆ›æ•¾é–»åº¢ç†?·ï¿?
  * @note       
  * @history
  *  Version    Date            Author          Modification
  *  V1.0.0     Nov-11-2019     RM              1. done
  *
  @verbatim
  ==============================================================================

  ==============================================================================
  @endverbatim
  ****************************(C) COPYRIGHT 2019 DJI****************************
  */

 /**
  * Modified the "RM referee system data solve" into CV_data receiving and processing
  * Commented out the original referee_usart_task function and added the UART7_CommandRoute function
 */

#include "referee_usart_task.h"
#include "main.h"
#include "cmsis_os.h"
#include "INS_task.h"

#include "bsp_usart.h"
#include "detect_task.h"

#include "CRC8_CRC16.h"
#include "fifo.h"
#include "protocol.h"
#include "referee.h"

#include <stdbool.h> // Include this header to use bool type


/**
  * @brief          single byte upacked 
  * @param[in]      void
  * @retval         none
  */
/**
  * @brief          é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚²î˜µéæ’»æ‚©é¡”ç‘°äº¾é–¸æ„µå––éªãˆ¡ä¿Šéå­˜ç?æ¿¡ç‚¶æ£„é?ï½†ç?ç€£å«æ™£é—ç»˜æ?å¨“ç‘°Î£é°ç‰ˆç…Ÿé–»æ–¿æ‘œé??ä¿Šé?ãˆ æš£é–»æ¶±å–—ç»»æ¿‹å´¶éŠŠãƒ¢å“é‘èŠ¥ç…•æ¿ é›æ£—é?î‚¦æŸ¨å¨‘æ¬‘çŸŠé–³è§„å¿é?•…î”™é‘²â•å§¶é—‚ä½¸æ†¡é¸è¯²îéŠŠâ•ææ¤¤æ›—å“é–¸ã„¦å„³é£çƒ½å´¶éŠŠï¸»å•é—‚å‚™æµ‡å¨‰æ›¢å´³é”•å‚šç?é–¿ç‡‚æ‹??
  * @param[in]      void
  * @retval         none
  */
static void referee_unpack_fifo_data(void);

 
extern UART_HandleTypeDef huart6;

uint8_t usart6_buf[2][USART_RX_BUF_LENGHT];

fifo_s_t referee_fifo;
uint8_t referee_fifo_buf[REFEREE_FIFO_BUF_LENGTH];
unpack_data_t referee_unpack_obj;
char dma_buf[50];

// é—‚å‚šå€¸éŠæå´é‘èŠ¥åš„é–¸î‚£æ´–çº¾å—æŸ£éŠâ‘¶åœ­å£•æ¿ æ°?…™é–¹è?åŠ¦é¤æ¬‘ç´’éˆ§î„å¾„é°î…â‚¬ç”¸æŸ¨å©µå—›î€—å?Ñ„å½ƒéˆ¹æˆ¦î”™é¸åº£å½§é—é›æ´¤ç€šä¼´ç?ºæ¥€ç®£æ¿ å?Š’é?½‡ç´“éŒæ¬’å…Œå©µî†¼çšç»»æ¶™ç¹é¥Ñ†æ‘•é—å“„æ´¨é åº£æ?éå?ç®¾é–¹å­˜ç‘¥éî…ã„æ´ï¼„Ğ§æ¿®å©ƒæ¤½å®•î‚¦å´Ÿé?å©„ç?å©µç‚²ç“¨ç»®çŠ³ç?é¡å‹µåš•å©µçŠ³ç?é…æ’îŸ¿ç’ºå¥½ï¿ åŸ¡é›î†¾åªæ¿ ãˆ£æ³›é—å—›å´å©Šå Ÿç…Ÿé–µå æ‡é¨ç‘¼é—‚å‚šå€¸éŠæå´å®„æ‡Šå½’å´¶è¤œå¨´æ ?Ÿ•æ¿ç‚¬æ«†é–¸ã‚…å?éŒã‚‡ç²™ç’ºã„¤ç²µå©µç‚²æ‡æ¿®å?©±æ¿ å›§Î§é–¸å±¾çŸ?¾¹æ›¢æ¢»æµ£é?ä¸²ç¼è¹?²™é?¨ºîç’ºè™¹î††é—å‘Šç¨‘é¡ã„©å¹†éçƒ˜ç…•é–¿æ—‡î‡§å¯?·¨ç´’æˆã„¥â–•æ¿?©„ç²?·å‘?²µç€£î‚¤ç§·é—‚ä½ºÇ¹æ?å“¥å?é¡“ç†ºç¶é–ºå›¥åŸ„éå›¬æŸ•è¹‡æ›Ğ¥æ¤¤æ—€å¿å?è™¹æ„éŠŠãƒ¦ç¢é—ç‘°åš–é·ï¿½
// DMA data buffer for reception
unsigned char rx_data[50];


/* å©µçŠµæ•¸æ¿®çƒ½å¼«é¼ä½¸ç£»æ¿æˆ™åŸ„éå?ã„é¾è·ºæ‘é–¸æ¬ç¹éœ‰é–¸å¿“å‹ç¼æˆ ç—ªé?„å¥é–ºå²€å–éˆ»æ’»å´¹é¡”ç•Œäº¾ç¼‚å‚™èƒ¶æ¿?›Î›éî†¼è“Ÿæ¿æˆÇšå¦²å Ÿç¹›é¡æ¨ºå§‰ç¼å¬?´­å§Šæ´ªå´¨æ¿ å‹?™§é—æŒæ´¦æµœî„î‡£æ¿ æ°¬Î©é–³å“„å€¸æµœæ»ˆæŸ£é˜å‰å¤„é–»ï½åŠéªæ©€å´œæµ£çŒ´ç´²é—è?å‡½ç¼å—˜ç?ç’ºä½•ç†¼åŸ€é¡’å‹¬â’‘ç¼îˆ›æ´˜é‰å½’æŸ›ç€£î‚£å°?¤¤î„å•´æ¿¡å •å´±å¦¤å†?†ªé—‚ä½ºå§éŸå—æ‚¥æ¿‚ç?æ˜¥é–µå¿‹å€•ç»«å¶‰æŸ›é¡ã‚…æ”é–¸æ¬æ?å§Šè™¹ç´’å¦¯çƒ©æ‹»é—ç?ç°ºéŠæ›¢åŸ¢å®¥å?å³é–µå¿¥ç´•é˜æ’»æ‚·å?å‹?Ÿ’ç€¹æ›Ÿç²Œéˆ½å¤å?é˜ç”µæƒé—‚ä½½î‰å®•æ©€î”šè?éˆ§î„è‰¾é¡¦ä¼´å¦µé•îˆšç®³é–¹å­˜ç¹æµ ç…â”‘é?æ¬¾æ½é–»æ“„ç¹å?å©šå¦¸éŠ‰ãˆ¡æ–€é—ç³•æª§é…æ»…ç‘§ç¼‚å‚šå€·é‘³èˆµæ…¨é?‚¤ç®¾å©µçŠ²æ´¤é’ƒç†¼æŸ¡é¥â•æç¼å‰åç»»æ¶¢å¹‹å¨†å¿•ä»¾å?ã‚…é?ç»‰ç‘°îå¨²î„ä¼ é–¸æ›¨å‰¨ç»±ç‚´ç¹›ç€›æ?çŸ¤å¨´æ»äºœé¡•ï½†ç¹å?î„‚åŠ´é—å‘ŠåŠé…æ¶¢î”“é¾ç»˜â’‘é–¸æ¶˜ï¹¦ç» æ’»æ‚—å?åå´ç€µî†½å¨Šé¡¢æ©€å§€éˆ¥æ–¥å“é¢å‘Šå¡æ¿å——ç¹é?îˆæ‚˜è¹‡ï½…äºç¼è¾¨å¸¡é³æ»„æ‹…éîŸ‘æ?é—‚ä½·ç´?»²å—å´—å§—â‚¬éªå†®åŸ¡éâ•ç°é—åœ­ç²?”¯ç‚ºæ‚°éˆºå‚™ç¹†é–»æ„µäºœéˆ§î„ç‰ é®ÑƒÎ”éî†ç…“é—è§„å´˜é¡•ÑƒĞ§éŒãƒ¦ç…Ÿæ¿¡îˆåç”¯æ¶¢æŸé–¿å?ç´é–ºå±¾ç¨‘éˆ¹æˆ¦å´±å¦¤å©ç´‘é—ç…å¼¶é—çŠ²îå¨²î„å·å©µçŠ²æµ·é”å •æ¢ºé¼ç‚²åŠ˜é–¸æ–¿ç§´éˆ»å¶‰å?éŠˆå—æ‹ºé–»çŠ³äº½é”å±½â–é°ç‰ˆç…™é–¸æˆ™å€–ç€šï¿½? */
/* é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚²î˜µéæ’»æ‚©éè¹­ç½•é—‚ä½¸æ«å¨²ãˆ¤å´¹é¦î… ä¸é–»æ?î‡§ç» è§„ç¹›é”åº¡å¢?©µï¼„å§é¡©å¥¸å´¨ç€›æ¨·æ‹ºé—å‘Šç¹‚ç€šî„„å¼³å¨†æ’´ç…Ÿæ¿¡ã‚‚å“é–¿æ›¨äºœé¡•ï½‰å¼»éŠ‰î†½æ™¢é—å‘Šæ´¦é“æ¶¢å´¢é–?¶†å¡æ¿ å©‚å?ç» ç‚´îš¥éèŒ??é–ºä½¹æ‡éæ’»æ•“é”Ÿï¿½55aé—‚å‚šå€¸éŠæå´é‘èŠ¥å€¿é–¿æ—ˆæ•®é‹æ’¶ç²?¨‘æ¨»å™½é–»î…Ÿç‘©éŒç†·â–éˆ¥å´‡æ¹´é–¸æ—€å¿å®•æ´?Ÿ€é¡’ä½µäºœé–¹çƒ˜åµéˆ§î„ƒå´µæ¾¹æ›Ÿç¸½é›å©„åµé—åœ?²¯ç”?•…å´•é°ç‰ˆå€µæ¿®æ¨¼å“ç€šï¿½2é—‚å‚šå€¸éŠå³°Ã¹é¥î„‰æ•‹ç‘œå¿›åŸ€é¡’ä½ºâ–“é–ºå‘?¹„é’æ‘â–é¾å´‡î†Šå©µï¼„å›é¨çƒ½å´‘é¾è?ç¤ƒé–³è½°èƒ¶ç»ç‚ºæŸ£æ´îˆœå²›é–ºå‘®ç¹„ç»®è¯²îé‘¸ç?æ‹ºé–»çŠ³äº½é”å±½â–é°ç‰ˆç…™é–¸æˆ™å€–ç€šï¿½ */
/* é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚²î˜µéæ’»æ‚©éè¹­ç½•é—‚ä½¸æ«å¨²ãˆ¤å´¹é¦î… ä¸é–»æ?æ«•é™å¿”ä¿Šéé?åš™å¨´æ»ˆç®–é??â–“é¨î†½ç•å©µç‚²æ‡å¨²æ §ç»é‘³îˆœç–€æ¿æˆîŸ‚éˆºå‘?…¥é–ºå›¨îš…æµœé¹ƒæ¢ºé›å©ƒç…¥é–¹è™??¡«å¿“Ãºé?å‹?†‡é–¹å…¼ç•?©å‹?é§æ?â’‘ç¼å¬?ƒ™éæ„°æŸ›éƒâ‚?¡¨å ¥å´šéºæ?æ™²å?è·ºîƒ†å¨…ãˆ¤æ¢ºç’ºã„¥æ«é–¹å‡¤æ‹?1é—‚å‚šå€¸éŠå³°Ã¹é¥î„‰æ•‹ç‘œå¿›åŸ€é¡’ä½ºâ–“é–ºå‘?¹„é’æ‘â–é¾å´‡î†Šå©µï¼„å›é¨çƒ½å´‘é¾è?ç¤ƒé–³è½°èƒ¶ç»ç‚ºæŸ£æ´îˆœå²›é–ºå‘®ç¹„ç»®è¯²îé‘¸ç?æ‹ºé–»çŠ³äº½é”å±½â–é°ç‰ˆç…™é–¸æˆ™å€–ç€šï¿½ */
/* ---å©µçŠµæ•¸æ¿®çƒ½å¼«é¼ä½¸ç£»æ¿æˆ™åŸ„éå?ã„é¾è·ºæ‘é–¸æ¬ç¹éœ‰é–¸å¿“å‹ç¼æˆ ç—ªé?„å¥é–ºå²€å–éˆ»æ’»å´¹é¡”ç•Œäº¾ç¼‚å‚™èƒ¶æ¿?›Î›éî†¼è“Ÿæ¿æˆÇšå¦²å Ÿç¹›é¡æ¨ºå§‰ç¼å¬?´­å§Šæ´ªå´¨æ¿ å‹?™§é—æŒæ´¦æµœî„î‡£æ¿ æ°¬Î©é–³å“„å€¸æµœæ»ˆæ¢ºé›å©ƒå°?–¼å†²çˆ¼é?¿ å¹˜ç¼æ¨ºâ‚¬å?¹›é?¿ˆä»¢é–ºå¬?›¯éŒï½ˆç®›éƒå›§î—å¦ã‚†æ´éé›ç•·é”ç¢±æ•‡æ¿æˆÃ¼æ¾¹æ›¢æ¢ºé¸åº£ç®“å¦¤çŠ²æ†¡ç»‚å¶…â”‘ç€£î‚¤å½å©µçŠ²çšé¸å‰§å¼§éˆ§î„€â”‘é?ç¡·æ”»æ¿¡ç‚¶æ£„é£çƒ½å¦¸é””å‰§ç˜ˆé—ç¨¿æœ¬é‘ç‘°á¸¿é¾ç»˜â’’å¨´ï½‡å„¤é¤â‚?—å“¥å–å¨¼ï¿ å¼»æ¿ å›¨æ™²å©¢è·ºï¹¥éî„„æ¢ºéŸæ¿â’”ç¼î‡…å¶å®•æˆ¦åŸ¡é›î†¼â‚¬å •æŸ£é°î†ç¥·æ¿¡å‰?¹éœ‰é–»æ¨»ç‘¥é³æ„??é’˜å?å½’æ•é•î… ç…“é—å‘Šç¹†å¨…ï½‡æ§éºæ—€å«šé–¼ç¢±å‰™é¡£å“„îœƒéŠˆå—˜ç©¿ç¼‚å¶„ç·šéªå†?´œè¤Œå¨ŒîˆæŸŸé¡–å——å«?ˆ§î„‰åƒå§Šç»˜æ‹…é›å©‚æšˆå©µç‚¶î‡œç» æ’³ç•·é´ï¹€å¹¢æ¿æˆîŸ‚è¤”éŒã„©å¼´éæµ‹å“è¤°æ‘ç…•é–¹çƒ˜îš†é“æ›¢æ‚˜éæ’â’”æ¤¤ï½ˆå°™ç»±æ—åŸ€é¡’â‚¬é£æ¿‹å´Ÿé?å‚šå¹ˆé—è?å‡½ç¼å—›å´‘é›îˆ™ç„Šå¨´ç…ç“¨é“æ¬ã€’å?î„‚ä»¢å©µî†¼å€¿éŒç†¼î”™é?ƒå¹‹éæ?å–›é©æ ?¹†éƒå ç®»é–¸å¿“æ‡é¡¥æ°­ç¹å¨ˆå?Ÿç¼è?å€»é®î‡€î”•é”å›¶æ´¸é—è¤å––é‹å©‡æ‚¢é¡æ¶™ç… é–¹é—´ç„¦å¨‘Ñƒâ”‘é¡”å…¼å·ç¼è¾¨å¸¡é©â‚¬æ¤¤æ‘å«?…ææŸ¨é•å‚›å«??--- */
/* hex_Yawé—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨´ï½ˆæ¡¨é’å©‡æŸ›å¨‘æ¬ç¶‘ç¼ç‹€å¶éŒã„©æ‚¤éŒæ¶˜î??4é—‚å‚šå€¸éŠå³°Ã¹é¥î„‰æ•‹ç‘œå¿›åŸ€é¡’ä½ºâ–“é–ºå‘?¹„é’æ‘â–é¾å´‡î†Šå©µï¼„å›é¨çƒ½å´‘é¾è?ç¤ƒé–³è½°èƒ¶ç»ç‚ºæŸ£æ´îˆœå²›é–ºå‘®ç¹„ç»®è¯²îé¡’å?å¯Œé—é›ç‰†å¦?¬‘äº¸é?å Ÿç…•é–µå?é™„éŠ‡æ¿ˆâ‚¬æ®¿å–—é“ï¿ ã€å¦¤å‘??æ¤¤æ‘å€¸éªå Ÿä¿Šéî„â‚? ­å´å¦¤ä½¹åé–¹ç»¢å––ç»€å¤‹ç¹æ¿ å‚šå¹˜ç‘œç‰ˆå¸—é‹æ„®ç´’å¨‘æ°¼æ”°é–³ÑŒå‰™å¨¼ï¿ å¼»é”ç¢±æ•Šé–¹îˆ†å†¨ç?é–»åº¢î†–é æ¥€á¸¿å¨†æ“„ç¶–æ¿ é›îƒéå›?Ÿ£å§—å——æ›å¨´çŠ³å¸’éˆ¹æˆ¦æ‚©é¨î‚£æ¯„é—ç?îƒ‡é‹æ¶˜ç»é?†¹æç€µé‚¦å…ç»‹æˆ¦åŸé´çŠ«å“é”åº¡å?ç¼ä¾Šç®“å?è™¹æ¶µé›î†¼æ¶§é—‚å‚šå?ç€šæ¿î‡£éŒãƒ¥ç?å¨´ï½…æ¹±é˜é¹ƒæ¢ºç’‡â€³å¹—é¢îˆ›å¸¡å®•æ¿‹å¦¶æ¾¶å?å“ç¼‚å‚™ç„¦è“±é–³é”‹å¸ç»±æ“æ½éŠŠãƒ¦è¯é—ç³•æ™›ç€šæ¿ç•·å?â‚?ˆ¥ï¹‚å¹‹éç‰ˆå”‰EE 754é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚´ç‰ é¡¢æ›¢å¦¶é¥â•ƒå é—‚ä½¸æ«é¡¦ä¼´å´µå?îƒæ´ªî””é•å¹?†¾ç††é è™¹å°¨éŸ?„ä¿Šé?ãˆ æ§»æ¤¤î„å•´æ¿¡å •å´±å¨†å¿Šæ‹¡é—‚ä½ºÇ¹é?å›?´‘éŠˆå‘¯æš¦é–ºå›©å„éšå?îŸ¿ç’ºä¾?„‘é–¸æ©€äº¶å?æ´?´«é•î„€åé—å‘ŠæŸ¨éˆî„‚ç²‹å?å‘? ªé–¸æ¶±å³é”›æ»ˆæ¢ºé–?‚²è‹?¾§ä¼´æŸè¤œé“ã„§ç´é¡æ¶˜ç¤ˆæ¿æˆè‰¾é¡¥æ°¶æŸ›è¹‡æ›¨å„ å¨´æ»„ç²“éŒï¿ å´˜éŠŠï¹€î˜©å?ã‚ƒå„±é¡¦ç”¸å¼»å¨‘ãˆ æ?é å›¨ç¥´é‹æ’³â”‘ç€£î†ç•ºå©µÂ°å€•é³å¿›å´‘é”ŸçŠ³ç…›å?è·ºîƒ…é¡•æ»„æ…¨é”å——å?æ¿?©‚îŸ·å®•æƒ°î™æ¿¡îˆ—å“é—‚ä½¸æ«çšî‚¦å´é´ï¹€ç®–é–µå¿‹å€•ç»€å Ã¹é”å Ÿî é–¸æ©†å¶å?ç»˜æ‹…ç»›å?æ®é—å“¥å§µé¡¨å©‡å¹ƒé¤îˆ£æ¨„å¦¤çŠµå›é¡¦ç”¸ç®å§—â‚¬é¡¢æ¬“æ‡–éˆºå©ƒĞ§å©µï¼„å‘éŠæ «æ•?¿ å‹?‚½é–¿ç†ºå§´é¤î‡€æŸè?é“ç†·îæ¿ æ°?£¼æ¿å—˜åµæ¿¡ä»‹æŸ£æ´ï½‡æ‡—é–¸ãƒ‘å’æ§°å©µçŠµæ•¸æ¿?”¸æ‡é“Ñ…ä¸æ¤¤æ ?é“ãƒ©æŸ£é‡ç‚²â‚¬åœ?‚¬æ°¾æ‹· */
/* hex_Pitché—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨´ï½ˆæ¡¨é’å©‡æŸ›å¨‘æ¬ç¶‘ç¼ç‹€å¶éŒã„©æ‚¤éŒæ¶˜î??4é—‚å‚šå€¸éŠå³°Ã¹é¥î„‰æ•‹ç‘œå¿›åŸ€é¡’ä½ºâ–“é–ºå‘?¹„é’æ‘â–é¾å´‡î†Šå©µï¼„å›é¨çƒ½å´‘é¾è?ç¤ƒé–³è½°èƒ¶ç»ç‚ºæŸ£æ´îˆœå²›é–ºå‘®ç¹„ç»®è¯²îé¡’å?å¯Œé—é›ç‰†å¦?¬‘äº¸é?å Ÿç…•é–µå?é™„éŠ‡æ¿ˆâ‚¬æ®¿å–—é“ï¿ ã€å¦¤å‘??æ¤¤æ‘å€¸éªå Ÿä¿Šéî„â‚? ­å´å¦¤ä½¹åé–¹ç»¢å––ç»€å¤‹ç¹æ¿ å‚šå¹˜ç‘œç‰ˆå¸—é‹æ„®ç´’å¨‘æ°¼æ”°é–³ÑŒå‰™å¨¼ï¿ å¼»é”ç¢±æ•Šé–¹îˆ†å†¨ç?é–»åº¢î†–é æ¥€á¸¿å¨†æ“„ç¶–æ¿ é›îƒéå›?Ÿ£å§—å——æ›å¨´çŠ³å¸’éˆ¹æˆ¦æ‚©é¨î‚£æ¯„é—ç?îƒ‡é‹æ¶˜ç»é?†¹æç€µé‚¦å…ç»‹æˆ¦åŸé´çŠ«å“é”åº¡å?ç¼ä¾Šç®“å?è™¹æ¶µé›î†¼æ¶§é—‚å‚šå?ç€šæ¿î‡£éŒãƒ¥ç?å¨´ï½…æ¹±é˜é¹ƒæ¢ºç’‡â€³å¹—é¢îˆ›å¸¡å®•æ¿‹å¦¶æ¾¶å?å“ç¼‚å‚™ç„¦è“±é–³é”‹å¸ç»±æ“æ½éŠŠãƒ¦è¯é—ç³•æ™›ç€šæ¿ç•·å?â‚?ˆ¥ï¹‚å¹‹éç‰ˆå”‰EE 754é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚´ç‰ é¡¢æ›¢å¦¶é¥â•ƒå é—‚ä½¸æ«é¡¦ä¼´å´µå?îƒæ´ªî””é•å¹?†¾ç††é è™¹å°¨éŸ?„ä¿Šé?ãˆ æ§»æ¤¤î„å•´æ¿¡å •å´±å¨†å¿Šæ‹¡é—‚ä½ºÇ¹é?å›?´‘éŠˆå‘¯æš¦é–ºå›©å„éšå?îŸ¿ç’ºä¾?„‘é–¸æ©€äº¶å?æ´?´«é•î„€åé—å‘ŠæŸ¨éˆî„‚ç²‹å?å‘? ªé–¸æ¶±å³é”›æ»ˆæ¢ºé–?‚²è‹?¾§ä¼´æŸè¤œé“ã„§ç´é¡æ¶˜ç¤ˆæ¿æˆè‰¾é¡¥æ°¶æŸ›è¹‡æ›¨å„ å¨´æ»„ç²“éŒï¿ å´˜éŠŠï¹€î˜©å?ã‚ƒå„±é¡¦ç”¸å¼»å¨‘ãˆ æ?é å›¨ç¥´é‹æ’³â”‘ç€£î†ç•ºå©µÂ°å€•é³å¿›å´‘é”ŸçŠ³ç…›å?è·ºîƒ…é¡•æ»„æ…¨é”å——å?æ¿?©‚îŸ·å®•æƒ°î™æ¿¡îˆ—å“é—‚ä½¸æ«çšî‚¦å´é´ï¹€ç®–é–µå¿‹å€•ç»€å Ã¹é”å Ÿî é–¸æ©†å¶å?ç»˜æ‹…ç»›å?æ®é—å“¥å§µé¡¨å©‡å¹ƒé¤îˆ£æ¨„å¦¤çŠµå›é¡¦ç”¸ç®å§—â‚¬é¡¢æ¬“æ‡–éˆºå©ƒĞ§å©µï¼„å‘éŠæ «æ•?¿ å‹?‚½é–¿ç†ºå§´é¤î‡€æŸè?é“ç†·îæ¿ æ°?£¼æ¿å—˜åµæ¿¡ä»‹æŸ£æ´ï½‡æ‡—é–¸ãƒ‘å’æ§°å©µçŠµæ•¸æ¿?”¸æ‡é“Ñ…ä¸æ¤¤æ ?é“ãƒ©æŸ£é‡ç‚²â‚¬åœ?‚¬æ°¾æ‹· */
/* ---å©µçŠµæ•¸æ¿®çƒ½å¼«é¼ä½¸ç£»æ¿æˆ™åŸ„éå?ã„é¾è·ºæ‘é–¸æ¬ç¹éœ‰é–¸å¿“å‹ç¼æˆ ç—ªé?„å¥é–ºå²€å–éˆ»æ’»å´¹é¡”ç•Œäº¾ç¼‚å‚™èƒ¶æ¿?›Î›éî†¼è“Ÿæ¿æˆá¸¿é†å—›æŸè?é“ç†·ç•·é´æ¿ƒæ?é–µå¿•å§·é“æˆç¹é¢é›Ğ¢æ¿è?ç®“é®ï¿ å¦·éˆºå‚œå½é—å“„å€¸éæ¿‹ã€‚é¶èŠ¥ç…Ÿæ¤¤æ’¶å–“é³å‘´æŸè¤œé“æ°¶î”™éî…çª—é–ºå¶å½éŠèˆµæ…¨å?å——å¢»é–¸ã‚†îšŠéŒæ¶¢å¼´éŠŠãƒ¥ç®°é—ç¨¿îƒ†é¹å›¬å¼?°î…Ÿå„Ÿé–³ãƒ¨å°™é‘å½’æ¢»æµ£è™¹å¸›ç¼ç»˜åŠ—é¹ãˆ â”‘é¡â•‚ç¶å©µç‚²æ¨Šæµœæ»ƒî†å©µå—æ”½é–»æ¨»å½ƒéˆ§î„æ‚‚é”ç‚²ç•é•îƒ½æ‹ºé—è¤å–å©¢æ©€å¼³é–¬å¶†â’‘é¢îˆ£å–šç»‰î†¾â‚¬æ®¿å™®é‹å©‡ç?¦¯è‚©ç£¼æ¿¡îˆœç²??ç†¼æ¢»æµ£èŠ¥ç¡¶é–¸ï½ç®“éªå¿›æ•“é”Ÿï¿??--- */
/* é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚´ç‰ é¡¢æ›¢å¦¶é¥â•ƒå?—‚ä½¸æ†¡å¨²ï¹‚å´¢é’˜å¤Œæš¦é–¸æ¬î˜±ç»¡â‚?—‚å‚šç‰Šæ¸šæ?å´•é°ç‰ˆç…•éï½å€–é´çŠ³å´²æ¿æˆ™å¹éªãˆ¡ä¿Šé¡–æ¿åš™ç»¾æ¿ç§´éˆ¹æˆ¦æ•é•î‚¡æˆ·é—å“„æ‹‹é‹å©‡å´ºéˆ§î„ã„éºå——äº¾é—å‘ŠÉ‘ç»?’³ç•·é´ï¹€ç®»ç¼‚ä½¹Ã?ˆ§î„‚æ•»éŒã„¥â”‘é¡æ¶±â‚¬æ¥€îŸ¿è?é—æŠ½å¼»é”å‘??é–¾å¿£å„é?ï¿?1é—‚å‚šå€¸éŠå³°Ã¹é¥î„‰æ•‹ç‘œå¿›åŸ€é¡’ä½ºâ–“é–ºå‘?¹„é’æ‘â–é¾å´‡î†Šå©µï¼„å›é¨çƒ½å´‘é¾è?ç¤ƒé–³è½°èƒ¶ç»ç‚ºæŸ£æ´îˆœå²›é–ºå‘®ç¹„ç»®è¯²îé‘¸ç?æ‹ºé–»çŠ³äº½é”å±½â–é°ç‰ˆç…™é–¸æˆ™å€–ç€šï¿½ */
/* é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚²î˜µéæ’»æ‚©éè¹­ç½•é—‚ä½¸æ«å¨²ãˆ¤å´¹é¦î… ä¸é–»æ?î‡§ç» è§„ç¹›é”åº¡å¢?©µâ€²ç²™éŒæ¶šâ‚?½äºœé?îˆæŸ•é¥Ñƒî­æ¥ ç‚´å¸¡éªå¬?”‘é°î†æ£?—‚å‚™ç?é¼î‚¦å¹ç€£î†¼ç¤ˆé–»æ—‚å§é’ƒç†¸ç¹›é´ç‚µçŸ¤æ¿¡æ’å‹ç»»æ¿†â–“é?†½ç†ç¼‚ä½½åŸ–é‘¹é¹ƒï½è¹‡æ’æ´ªî””é•î…§å”¶é—ç?å£ˆé»î†å¾Šéå‹ï½‰å´¼å©µæ„­å¯Œé—é›æ´¦æ¾§åº¨å´‘é¾ç»˜ç…•éï½å…çç”µç´’æˆã„¦å°°é–¹å³°æ‡˜é?ƒ½æ‚§é«ç†¸ç˜é—‚å‚™èƒ¶é³æ’»å´µéî…ç®?–¿ç‡‚æ‹·1é—‚å‚šå€¸éŠå³°Ã¹é¥î„‰æ•‹ç‘œå¿›åŸ€é¡’ä½ºâ–“é–ºå‘?¹„é’æ‘â–é¾å´‡î†Šå©µï¼„å›é¨çƒ½å´‘é¾è?ç¤ƒé–³è½°èƒ¶ç»ç‚ºæŸ£æ´îˆœå²›é–ºå‘®ç¹„ç»®è¯²îé‘¸ç?æ‹ºé–»çŠ³äº½é”å±½â–é°ç‰ˆç…™é–¸æˆ™å€–ç€šï¿½ */
/* Below is the format of a complete received packet */
/* Header (a55a): 2 bytes */
/* Packet length: 1 byte */
/* ---Below is the payload, subject to change as per requirements--- */
/* hex_Yaw: 4 bytes (to be converted to IEEE 754 standard single precision floating point) */
/* hex_Pitch: 4 bytes (to be converted to IEEE 754 standard single precision floating point) */
/* ---Above is the payload--- */
/* Checksum: 1 byte */
/* Footer (ff): 1 byte */

// é—‚å‚šå€¸éŠå³°Ã¹é¥î„‰æ•‹ç‘œå¶‰ï½å©µå¬?™é–¸å²‹å¦‡ç»‹å¿”ç¹éŠï½…ç…é–¸æ—€ç‰ å®•æ›Î”æµ£å…¸ç°»é—å“„å€¸éæ¿‹åŸ›é‚åº“æ§ˆé–¹æƒ§ç£­æ•ˆé—å“„çŸ‰ç¼ä½¸î‡£é?å‹??é¼æ·¬å¹é‹æˆ¦æ¢»æµ£å“¥ï¼ç¼î‡…å°èé–¸æ„µå––é’ƒç†ºâ‚?¹¿å„±é—æ»ƒîŠéŠŠâ•‚â’‘é–¸æ¶˜ï¹¥çç‰ˆæ…¨å¦¯ç¨¿å?é–¸æ“å¸’éˆ»åº¨å¹‡é¡’å‚œç?—‚ä½¸ç¶Šé‹å©‡å´¢é’˜å¤†æé–µå¿‹å€–éˆ·æˆÃ¹éè‚©æ‡…é–¸æ“æ¾˜é¡­è·¨æ„é‘æ¨ºæ éè§„æ´˜é¨å—ç?¦¯è‚©ç£¼æ¿¡îˆæ¡¨é¢å©šæ¢»æµ£è™¹å¸›æ¤¤ã„¥æ‡˜é?„ç¹é¥Ñ…î††é—‚ä¾‡å‰™ç»‰ç”¸åŸ›é´ï¸½ç…•æ¿ é›æ?é¡îˆæŸ¨å¨‘æ¬â’’ç¼è¾¨æŒ¸é?å¥¸å´Ÿé¡“çŠµå´²æ¿¡ã‚‡å§·é‹æ¶˜Î›å©µå—™æš¦æ¿®æ¤»å“æ¤¤ãˆ¡ç‘©é³æ ?Ÿ¡æ¿ å†ƒÑƒâ”‘é”›å‹?º¼é–¸å©ƒç‰œéî†½ç¹é¥ã„¥â‚?—æŸ¨é‡ç‚²äºé–ºä½¸ï¹¦éˆ§î„€ç®ééË‡æµ¼æ‘ç…•é–¹è¾¾é™„é“æ›¢æŸ¨éƒå›¶åš™æ?ç‚´îš†éŠ‡å‹®ç®›é‡ç‚´çˆé—å“„ç¼é æ„°Ë‡é—å Ÿå„Ÿé–³ãƒ¥å•¿ç» ï½‰æ¢»æµ£å‘Šæƒˆé–ºå ?‰Ÿé?‹¯î”›éå‰ç€?—ç‘°å¢½ç»?ˆå¼²é¼ä½¹ç…¥é–»æ›å€¹ç€šï¿½?
// define a complete packet
uint8_t packet[CV_PACKET_LENGTH];


/**
  * @brief          referee task
  * @param[in]      pvParameters: NULL
  * @retval         none
  */
/**
  * @brief          é—‚å‚šå€¸éŠå³°Ã¹é¥Ñ…æš¦é–»ãˆ¢Ç¹ç»æ¥ƒâ‚¬å¹¿å„±é·å?ã€’æ¿ æ°?…™é–»æˆÉ‘éˆ·æ—æŸ£é?ç‚´î—œé–µå—˜å¸’é¡«æ¿‹æ•é›î„€î—šé—è¯²æ°¦é¡??Ãºéî‚¤ç¤Šå©µçŠ²æ´¤ç» æ ­æŸ›é¾æ¥€å€¹é•å†?¢ºé‘ºãƒƒîˆË‡æµ å¬?¹æ¿å—˜æŒ»éˆ·æ‘Ã¹é”å‘?ƒˆé¢îˆåŸ–éŠ‡å‹?”•é”å—™î˜°éè§„æ´˜é”æ›¡çƒé—å‘Šä¾—é˜è—‰Î£é¡’å‹¬â’‘ç¼‚ä½¹ã€’è¤°æ¤å?å´±å?ãƒ¤æ±—é—åœ­å„¤é¸å‘Šç?ç‘™å‹­ç®¾é–¹ç‚?½™é¤î„„æŸ›éŠŠï¸½ç·²é–³ç»˜æ‡é¡¢æ©€æ‚¢é“åœ??æ¿ ç”µå›é—å—›æ‚˜å©µå—ææ¿å—˜æŒ»é“æ¬“æŸ›é´æ¬â‚¬æ ?‚¬æ°¾æ‹·
  * @param[in]      pvParameters: NULL
  * @retval         none
  */
void referee_usart_task(void const * argument)
{

  memset(dma_buf, 0, 200);
	memset(rx_data, 0, 50);
	const fp32* imu = get_INS_angle_point();
	while(1){
		sprintf((char *)dma_buf, "A5%f,%f,%f", imu[0],imu[1],imu[2]);
	HAL_UART_Transmit_DMA(&huart6, (uint8_t*)dma_buf, strlen((const char*)dma_buf));
	HAL_UART_Receive_DMA(&huart6, (uint8_t*)rx_data, sizeof(rx_data)); 
		
	}
}

void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart)
{
    if (huart->Instance == USART6)  
    {
			//HAL_UART_Receive_DMA(&huart6, (uint8_t*)rx_rdata, 9);
			HAL_UART_Transmit_DMA(&huart6, (uint8_t*)dma_buf, strlen((const char*)dma_buf));
    }
}

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart) 
{
	if (huart->Instance == USART6)  
  {
		UART7_CommandRoute(); 
		HAL_UART_Receive_DMA(&huart6, (uint8_t*)rx_data, sizeof(rx_data));
		
	}
}

// use to find the first complete packet from rx_data, if find A5 and come with 5A, then 
bool find_CpltPacket(void){
  for (size_t i = 0; i < sizeof(rx_data); i++){
    // find A55A
    if (rx_data[i] == 0xA5 && rx_data[i+1] == 0x5A){
      // find FF
      if (rx_data[i+sizeof(packet)-1] == 0xFF){
        // copy the packet
        memcpy(packet, &rx_data[i], sizeof(packet));
				return true;
      }
    }
  }
	return false;
}


cv_Data_TypeDef cv_Data;
void UART7_CommandRoute(void){
			// get a complete packet by checking the rx_data
      bool packetFound = find_CpltPacket();

			// If no complete packet was found, return early and skip the rest
			if (!packetFound) {
				return;
			}
      
      HexToFloat yaw;
      HexToFloat pitch;

      // get Yaw
      uint32_t temp_Yaw = (uint32_t)packet[3] << 24 |
                          (uint32_t)packet[4] << 16 |
                          (uint32_t)packet[5] << 8  |
                          (uint32_t)packet[6];
      yaw.hex = temp_Yaw;
      cv_Data.yaw = yaw.floatValue;

      // get Pitch
      uint32_t temp_Pitch = (uint32_t)packet[7] << 24 |
                            (uint32_t)packet[8] << 16 |
                            (uint32_t)packet[9] << 8  |
                            (uint32_t)packet[10];
      pitch.hex = temp_Pitch;
      cv_Data.pitch = pitch.floatValue;
			
			// get Find_Target status
			cv_Data.find_target = (char)packet[12];

      // get the new cv data flag
      detect_hook(USER_USART_DATA_TOE);
      cv_Data.new_cv_data_flag = 1;
	}


/**
  * @brief          single byte upacked 
  * @param[in]      void
  * @retval         none
  */
/**
  * @brief          é—‚å‚šå€¸éŠæå´æ¤‹åº£çŸ†å¨“æ°£å“æ¥ ç‚²î˜µéæ’»æ‚©é¡”ç‘°äº¾é–¸æ„µå––éªãˆ¡ä¿Šéå­˜ç?æ¿¡ç‚¶æ£„é?ï½†ç?ç€£å«æ™£é—ç»˜æ?å¨“ç‘°Î£é°ç‰ˆç…Ÿé–»æ–¿æ‘œé??ä¿Šé?ãˆ æš£é–»æ¶±å–—ç»»æ¿‹å´¶éŠŠãƒ¢å“é‘èŠ¥ç…•æ¿ é›æ£—é?î‚¦æŸ¨å¨‘æ¬‘çŸŠé–³è§„å¿é?•…î”™é‘²â•å§¶é—‚ä½¸æ†¡é¸è¯²îéŠŠâ•ææ¤¤æ›—å“é–¸ã„¦å„³é£çƒ½å´¶éŠŠï¸»å•é—‚å‚™æµ‡å¨‰æ›¢å´³é”•å‚šç?é–¿ç‡‚æ‹??
  * @param[in]      void
  * @retval         none
  */
void referee_unpack_fifo_data(void)
{
 uint8_t byte = 0;
 uint8_t sof = HEADER_SOF;
 unpack_data_t *p_obj = &referee_unpack_obj;

 while ( fifo_s_used(&referee_fifo) )
 {
   byte = fifo_s_get(&referee_fifo);
   switch(p_obj->unpack_step)
   {
     case STEP_HEADER_SOF:
     {
       if(byte == sof)
       {
         p_obj->unpack_step = STEP_LENGTH_LOW;
         p_obj->protocol_packet[p_obj->index++] = byte;
       }
       else
       {
         p_obj->index = 0;
       }
     }break;
     
     case STEP_LENGTH_LOW:
     {
       p_obj->data_len = byte;
       p_obj->protocol_packet[p_obj->index++] = byte;
       p_obj->unpack_step = STEP_LENGTH_HIGH;
     }break;
     
     case STEP_LENGTH_HIGH:
     {
       p_obj->data_len |= (byte << 8);
       p_obj->protocol_packet[p_obj->index++] = byte;

       if(p_obj->data_len < (REF_PROTOCOL_FRAME_MAX_SIZE - REF_HEADER_CRC_CMDID_LEN))
       {
         p_obj->unpack_step = STEP_FRAME_SEQ;
       }
       else
       {
         p_obj->unpack_step = STEP_HEADER_SOF;
         p_obj->index = 0;
       }
     }break;
     case STEP_FRAME_SEQ:
     {
       p_obj->protocol_packet[p_obj->index++] = byte;
       p_obj->unpack_step = STEP_HEADER_CRC8;
     }break;

     case STEP_HEADER_CRC8:
     {
       p_obj->protocol_packet[p_obj->index++] = byte;

       if (p_obj->index == REF_PROTOCOL_HEADER_SIZE)
       {
         if ( verify_CRC8_check_sum(p_obj->protocol_packet, REF_PROTOCOL_HEADER_SIZE) )
         {
           p_obj->unpack_step = STEP_DATA_CRC16;
         }
         else
         {
           p_obj->unpack_step = STEP_HEADER_SOF;
           p_obj->index = 0;
         }
       }
     }break;  
     
     case STEP_DATA_CRC16:
     {
       if (p_obj->index < (REF_HEADER_CRC_CMDID_LEN + p_obj->data_len))
       {
          p_obj->protocol_packet[p_obj->index++] = byte;  
       }
       if (p_obj->index >= (REF_HEADER_CRC_CMDID_LEN + p_obj->data_len))
       {
         p_obj->unpack_step = STEP_HEADER_SOF;
         p_obj->index = 0;

         if ( verify_CRC16_check_sum(p_obj->protocol_packet, REF_HEADER_CRC_CMDID_LEN + p_obj->data_len) )
         {
           referee_data_solve(p_obj->protocol_packet);
         }
       }
     }break;

     default:
     {
       p_obj->unpack_step = STEP_HEADER_SOF;
       p_obj->index = 0;
     }break;
   }
 }
}


void USART6_IRQHandler(void)
{
   static volatile uint8_t res;
   if(USART6->SR & UART_FLAG_IDLE)
   {
       __HAL_UART_CLEAR_PEFLAG(&huart6);

       static uint16_t this_time_rx_len = 0;

       if ((huart6.hdmarx->Instance->CR & DMA_SxCR_CT) == RESET)
       {
           __HAL_DMA_DISABLE(huart6.hdmarx);
           this_time_rx_len = USART_RX_BUF_LENGHT - __HAL_DMA_GET_COUNTER(huart6.hdmarx);
           __HAL_DMA_SET_COUNTER(huart6.hdmarx, USART_RX_BUF_LENGHT);
           huart6.hdmarx->Instance->CR |= DMA_SxCR_CT;
           __HAL_DMA_ENABLE(huart6.hdmarx);
           fifo_s_puts(&referee_fifo, (char*)usart6_buf[0], this_time_rx_len);
           detect_hook(REFEREE_TOE);
       }
       else
       {
           __HAL_DMA_DISABLE(huart6.hdmarx);
           this_time_rx_len = USART_RX_BUF_LENGHT - __HAL_DMA_GET_COUNTER(huart6.hdmarx);
           __HAL_DMA_SET_COUNTER(huart6.hdmarx, USART_RX_BUF_LENGHT);
           huart6.hdmarx->Instance->CR &= ~(DMA_SxCR_CT);
           __HAL_DMA_ENABLE(huart6.hdmarx);
           fifo_s_puts(&referee_fifo, (char*)usart6_buf[1], this_time_rx_len);
           detect_hook(REFEREE_TOE);
       }
   }
}


